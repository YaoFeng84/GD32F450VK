/********************************************************************************************************************************************
*                                                                                                                                           *
*              ---------------------------------以下是模块的修改记录区-----------------------------------------                             *
*                                                                                                                                           *
********************************************************************************************************************************************/
/**********************************************
 * 内容：
 * 日期：2022-06-23
 * 作者：YJX
 * 版本号：V1.0（初版）
 ***********************************************
 * 修改内容：
 * 修改日期：
 * 修改作者：
 * 版本号：
 ***********************************************
*/
/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下模块的说明区-----------------------------------------                                  *
*                                                                                                                                           *
********************************************************************************************************************************************/
/*	

*/
#include "DRI_ComDriver.h"
/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下模块的对接函数区-----------------------------------------                                  *
*                                                                                                                                           *
********************************************************************************************************************************************/

/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下是模块的变量申明和宏定义区--------------------------------                      *
*                                                                                                                                           *
********************************************************************************************************************************************/
#define INTMaxNUM        90  //GD32F450VK最大中断号

static DRI_ComDriver_DoubleVoidFuncType HardFaultIntterrupt_FCB = NULL;
/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下是模块的内部函数申明区------------------------------------                          *
*                                                                                                                                           *
********************************************************************************************************************************************/


/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下是模块的系统函数代码区------------------------------------                          *
*                                                                                                                                           *
********************************************************************************************************************************************/
void HardFault_Handler(void)
{
     if(HardFaultIntterrupt_FCB)
     {
          HardFaultIntterrupt_FCB();
     }
}

/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下是模块的用户函数代码区------------------------------------                          *
*                                                                                                                                           *
********************************************************************************************************************************************/

void NULLFP(void)
{
	
}

u8* DRI_ComDriver_OutVersion(void)
{
     return (u8*)"V1.03.250912";
}

//返回芯片Flash空间大小，单位：字节
u32 DRI_ComDriver_OutFlashSize(void)
{
     return ((*(u32*)0x1FFF7A20) >> 16) * 1024;
}

//返回芯片RAM空间大小，单位：字节
u32 DRI_ComDriver_OutRAMSize(void)
{
     return (0x0000FFFF & *(u32*)0x1FFF7A20) * 1024;
}

//uid1:(0~31)、uid2:(32~63)、uid3:(64~95)共96位
void DRI_ComDriver_OutUID(u32 *uid1, u32 *uid2, u32 *uid3)
{
     *uid1 = *(u32*)0x1FFF7A10;    
     *uid2 = *(u32*)0x1FFF7A14;
     *uid3 = *(u32*)0x1FFF7A18;
}



void DRI_ComDriver_Delay1ms(void) 
{
     // 200MHz下，1ms = 200,000个时钟周期
     // 假设每次循环迭代耗时4周期（需实际测试调整）
     vu32 i;
     for (i = 0; i < 50000; i++) 
     {  // 50000 * 4 = 200,000周期 ≈ 1ms
          __NOP();  // 可选：增加确定性
     }
}

void DRI_ComDriver_Delay1us(void) 
{
     // 200MHz下，1μs = 200个时钟周期
     // 假设每次循环迭代耗时4周期
     vu32 i;
     for (i = 0; i < 50; i++) 
     {  // 50 * 4 = 200周期 ≈ 1μs
          __NOP();  // 可选：增加确定性
     }
}

/***************************************************************************
* 函 数 名: DRI_ComDriver_SetHardFaultIntterrupt_FCB
* 功能描述：设置硬件错误中断回调 函数
* 入口参数：
            DRI_ComDriver_DoubleVoidFuncType fcbp：硬件错误中断回调函数指针
* 出口参数：
            无
* 注意事项:  
            
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_SetHardFaultIntterrupt_FCB(DRI_ComDriver_DoubleVoidFuncType fcbp)
{
     HardFaultIntterrupt_FCB = fcbp;
}

/***************************************************************************
* 函 数 名: DRI_ComDriver_SetSP
* 功能描述：设置栈顶指针 函数
* 入口参数：
            u32 _sp:栈顶指针值
* 出口参数：
            无
* 注意事项:  
            修改栈顶指针
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_SetSP(u32 _sp)
{
     __set_MSP(_sp);
}



/*-------------------------------------------------
函数名:DRI_ComDriver_DisableAllPeripheralInterrupt
功   能:关闭所有外设的各自中断
参   数:
       无
返回值:
       无
注   意:
       无
示   例:
作   者:YJX
版   本:V1.0
时   间:2025-09-08
-------------------------------------------------*/
void DRI_ComDriver_DisableAllPeripheralInterrupt(void)
{
     u8 in;
     //关闭所有外设中断(注意，此处90对应GD32F450VK芯片外设中断号的最大值，不同芯片可能不一样)
     for(in = 0;in <= INTMaxNUM;in++)
     {
          NVIC_DisableIRQ((IRQn_Type)in);
     }
}

/*-------------------------------------------------
函数名:DRI_ComDriver_ResetAllPeripheral
功   能:复位所有外设
参   数:
       无
返回值:
       无
注   意:
       无
示   例:
作   者:YJX
版   本:V1.0
时   间:2025-09-08
-------------------------------------------------*/
void DRI_ComDriver_ResetAllPeripheral(void)
{
//     NMI_DeInit();
//     PORT_DeInit();     
}

//开启总中断C语言写法
/***************************************************************************
* 函 数 名: DRI_ComDriver_EnableAllINT
* 功能描述：使能外设总中断 函数
* 入口参数：
            无
* 出口参数：
            无
* 注意事项:  
            无
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_EnableAllINT(void)
{
     __set_PRIMASK(0);//开启总中断
     //__enable_irq();
} 

//开启总中断汇编写法
//void __asm DRI_ComDriver_EnableAllINT1(void)
//{
//     CPSIE I //开启总中断
//}

//关闭总中断C语言写法
/***************************************************************************
* 函 数 名: DRI_ComDriver_DisableAllINT
* 功能描述：禁能外设总中断 函数
* 入口参数：
            无
* 出口参数：
            无
* 注意事项:  
            无
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_DisableAllINT(void)
{
     __set_PRIMASK(1);//关闭总中断
     //__disable_irq();
}

//关闭总中断汇编写法
//void __asm DRI_ComDriver_DisableAllINT1(void)
//{
//     CPSID I //关闭总中断
//}


//开启总异常C语言写法
/***************************************************************************
* 函 数 名: DRI_ComDriver_EnableAllFault
* 功能描述：使能内核总异常 函数
* 入口参数：
            无
* 出口参数：
            无
* 注意事项:  
            无
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_EnableAllFault(void)
{
     __set_FAULTMASK(0);//开启总异常
}

//开启总异常汇编写法
//void __asm DRI_ComDriver_EnableAllFault1(void)
//{
//     CPSIE F //开启总异常
//}

//关闭总异常C语言写法
/***************************************************************************
* 函 数 名: DRI_ComDriver_DisableAllFault
* 功能描述：禁能内核总异常 函数
* 入口参数：
            无
* 出口参数：
            无
* 注意事项:  
            无
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_DisableAllFault(void)
{
     __set_FAULTMASK(1);//来关闭总异常
}

//关闭总异常汇编写法
//void __asm DRI_ComDriver_DisableAllFault1(void)
//{
//     CPSID F //来关闭总异常
//}



//内核复位_C
/***************************************************************************
* 函 数 名: DRI_ComDriver_CoreReset
* 功能描述：内核复位 函数
* 入口参数：
            无
* 出口参数：
            无
* 注意事项:  
            无
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_CoreReset(void)
{
     __DSB();
     //置位VECTRESET
     SCB->AIRCR  = ((0x5FA << SCB_AIRCR_VECTKEY_Pos)      |
                    (SCB->AIRCR & SCB_AIRCR_PRIGROUP_Msk) |
                    SCB_AIRCR_VECTRESET_Msk);
     __DSB();
     while(1);
}

//内核复位_汇编
/*
void __asm NVIC_CoreReset_a(void)

{

  LDR R0, =0xE000ED0C

  LDR R1, =0x05FA0001  //置位VECTRESET

  STR R1, [R0]

//;deadloop_Core

//  ;B deadloop_Core

}
*/
//内核主要注意：SCB_AIRCR_VECTRESET_Msk和LDR R1, =0x05FA0001，它是和系统复位唯一的区别。


//系统复位
//C语言版函数：

/***************************************************************************
* 函 数 名: DRI_ComDriver_SysReset
* 功能描述：外设复位 函数
* 入口参数：
            无
* 出口参数：
            无
* 注意事项:  
            无
* 例     如:
* 修改记录 :
*           2025-09-08 BY:YJX
***************************************************************************/
void DRI_ComDriver_SysReset(void)
{
     //NVIC_SystemReset();

     __DSB();
     SCB->AIRCR  = ((0x5FA << SCB_AIRCR_VECTKEY_Pos)      |
                    (SCB->AIRCR & SCB_AIRCR_PRIGROUP_Msk) |
                    SCB_AIRCR_SYSRESETREQ_Msk);
     __DSB();
     while(1);
}

/********************************************************************************************************************************************
*                                                                                                                                           *
*               ----------------------------------以下是模块的内部函数代码区------------------------------------                          *
*                                                                                                                                           *
********************************************************************************************************************************************/












